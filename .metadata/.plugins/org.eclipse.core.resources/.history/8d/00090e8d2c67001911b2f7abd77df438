package com.ssafy.edu.controller;

import java.util.Date;

import javax.servlet.http.HttpSession;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import com.ssafy.edu.dao.UserDao;
import com.ssafy.edu.dto.UserDto;
import com.ssafy.edu.service.IUserService;

@Controller
public class UserController {

	private static final Logger logger = 
			LoggerFactory.getLogger(UserController.class);
	
	@Autowired
	private IUserService iUserService;
	
	@RequestMapping(value = "regibf.do", 
			method = {RequestMethod.GET,RequestMethod.POST})
	public String regibf(Model model) throws Exception {
		logger.debug("Welcome UserController regibf------------------! "+ new Date());
		//model.addAttribute("emplist", iEmpService.getEmplist() );
		//model.addAttribute("hello", "hello my name is ydg.");
		return "regi";
	}//		
	@RequestMapping(value = "regiaf.do", 
			method = RequestMethod.POST)
	public String regiaf(@ModelAttribute UserDto userdto,Model model, HttpSession session) throws Exception {
		logger.debug("Welcome UserController regiaf------------------! "+ new Date());
		try {
			iUserService.addUser(userdto);
		}catch(Exception  e){
			logger.debug("Welcome UserController regiaf fail------------------! "+ new Date());
		}
		//model.addAttribute("emplist", iEmpService.getEmplist() );
		//model.addAttribute("hello", "hello my name is ydg.");
		return "login";
	}//	
	@RequestMapping(value = "loginbf.do", 
			method = {RequestMethod.GET,RequestMethod.POST})
	public String loginbf(@ModelAttribute UserDto userdto,Model model) throws Exception {
		logger.debug("Welcome UserController loginbf------------------! "+ new Date());
		return "login";
	}//	
	@RequestMapping(value = "logout.do", 
			method = RequestMethod.GET)
	public String logout(Model model, HttpSession session) throws Exception {
		logger.debug("Welcome UserController logout------------------! "+ new Date());
		session.invalidate();
		return "login";
	}//	
	@RequestMapping(value = "loginaf.do", 
			method = RequestMethod.POST)
	public String loginaf(@ModelAttribute UserDto userdto,Model model, HttpSession session) throws Exception {
		logger.debug("Welcome UserController regiaf------------------! "+ new Date());
		logger.debug("Welcome UserController regiaf------------------! "+ userdto);
		String path="forward:/";
		try {
			UserDto logindto= iUserService.userlogin(userdto);
			logger.debug("Welcome UserController regiaf------------------! "+ logindto);
			if(logindto==null || logindto.getUser_id()==null) {
				throw new Exception("아이디 체크하세요.");
			}
			session.setAttribute("login", logindto);
			session.setMaxInactiveInterval(10*60);//10분
			path="hello";
		}catch(Exception  e){
			path="redirect:/regibf.do";
			logger.debug("Welcome UserController loginaf fail------------------! "+ new Date());
		}
		//model.addAttribute("emplist", iEmpService.getEmplist() );
		//model.addAttribute("hello", "hello my name is ydg.");
		return path;
	}//	
	
	@RequestMapping(value = "modifyme.do", 
			method = RequestMethod.GET)
	public String modifyme(Model model,HttpSession session) throws Exception {
		logger.debug("Welcome UserController modifyme------------------! "+ new Date());
		
		UserDto logindto=(UserDto)session.getAttribute("login");
		UserDto userdto= iUserService.getUserById(logindto.getUser_id());
		model.addAttribute("user", userdto);

		return "modifyme";
	}//
	
	//modifyaf
	
	@RequestMapping(value = "modifyaf.do", 
			method = RequestMethod.POST)
	public String modifyaf(@ModelAttribute UserDto userdto,Model model, HttpSession session) throws Exception {
		logger.debug("Welcome UserController modifyaf------------------! "+ new Date());
		try {
			iUserService.updateUser(userdto);
			UserDto newUser=iUserService.getUserById(userdto.getUser_id());
			session.setAttribute("login", newUser);
		}catch(Exception  e){
			logger.debug("Welcome UserController modifyaf fail------------------! "+ new Date());
		}
		//model.addAttribute("emplist", iEmpService.getEmplist() );
		//model.addAttribute("hello", "hello my name is ydg.");
		return "hello";
	}//
	
	@RequestMapping(value = "deleteme.do", 
			method = RequestMethod.GET)
	public String deleteme(Model model,HttpSession session) throws Exception {
		logger.debug("Welcome UserController deleteme------------------! "+ new Date());
		UserDto logindto=(UserDto)session.getAttribute("login");
		//UserDto userdto= iUserService.getUserById(logindto.getUser_id());
		iUserService.deleteUser(logindto.getUser_id());
		return "redirect:/logout.do";
	}//
	
	
	
	
}
